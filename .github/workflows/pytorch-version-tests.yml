name: PyTorch version tests

on:
  # https://docs.github.com/en/free-pro-team@latest/actions/reference/workflow-syntax-for-github-actions#onschedule
  schedule:
    # Run at 00:00 UTC Every Day
    - cron: "0 0 * * *"
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/pytorch-version-tests.yml"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      UV_SYSTEM_PIP: 1
      CLEARML_OFFLINE_MODE: 1
      CLEARML_API_HOST: http://localhost
      CLEARML_WEB_HOST: http://localhost
      CLEARML_FILES_HOST: http://localhost
    timeout-minutes: 85
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        python-version: [3.9, "3.10", "3.11"]
        pytorch-version: [2.5.1, 2.4.1, 2.3.1, 2.2.2, 1.13.1, 1.12.1, 1.10.0]
        exclude:
          - pytorch-version: 1.10.0
            python-version: "3.10"
          - pytorch-version: 1.10.0
            python-version: "3.11"
          - pytorch-version: 1.11.0
            python-version: "3.10"
          - pytorch-version: 1.11.0
            python-version: "3.11"
          - pytorch-version: 1.12.1
            python-version: "3.11"
          - pytorch-version: 1.13.1
            python-version: "3.11"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v3
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('requirements-dev.txt') }}
      - name: Install uv and Python
        uses: astral-sh/setup-uv@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install PyTorch ${{ matrix.pytorch-version }}
        run: |
          if [[ "${{ matrix.pytorch-version }}" == 2.* || "${{ matrix.pytorch-version }}" == 1.13* || "${{ matrix.pytorch-version }}" == 1.12* || "${{ matrix.pytorch-version }}" == 1.10* ]]; then
            uv pip install torch==${{ matrix.pytorch-version }} torchvision --extra-index-url https://download.pytorch.org/whl/cpu
          else
            uv pip install torch==${{ matrix.pytorch-version }} torchvision
          fi
          uv pip install setuptools

      - name: Install numpy conditionally for PyTorch < 2.3
        run: |
          version=$(python -c "import torch; print(float('.'.join(torch.__version__.split('.')[:2])))")
          if (( $(echo "$version < 2.3" | bc -l) )); then
            uv pip install "numpy<2.0"
          fi

      - name: Install Ignite dependencies
        run: |
          uv pip install -r requirements-dev.txt
          uv pip install -e .

          # Patch setuptools for old PyTorch versions
          version=$(python -c "import torch; print('.'.join(torch.__version__.split('.')[:2]))")
          if [[ "$version" == "1.9" || "$version" == "1.10" ]]; then
            pip install "setuptools<59" "distutils==0.3"
          fi

      - name: Download MNIST
        uses: pytorch-ignite/download-mnist-github-action@master
        with:
          target_dir: /tmp

      - name: Run Tests
        uses: nick-fields/retry@v3
        with:
          max_attempts: 5
          timeout_minutes: 15
          shell: bash
          command: bash tests/run_cpu_tests.sh "not test_time_profilers"
          new_command_on_retry: USE_LAST_FAILED=1 bash tests/run_cpu_tests.sh "not test_time_profilers"

  create-issue:
    runs-on: ubuntu-latest
    # https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#needs-context
    needs: build
    if: always() && needs.build.result == 'failure'
    steps:
      - uses: actions/checkout@v4
      - uses: JasonEtco/create-an-issue@v2
        name: Create issue if pytorch version tests failed
        with:
          filename: .github/failed_schedule_issue_template.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
